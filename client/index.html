<!DOCTYPE html>
<html>
<head>
    <title>Production Chat</title>
    <style>
        body { font-family: Arial; display: flex; }
        #chat { flex: 3; padding: 10px; }
        #users { flex: 1; border-left: 1px solid #ccc; padding: 10px; }
        #messages { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 5px; }
        #input { width: 80%; padding: 8px; }
        #send { padding: 8px; }
    </style>
</head>
<body>

<div id="chat">
    <h3>Chat</h3>
    <div id="messages"></div>
    <input type="text" id="input" placeholder="Type message..." />
    <button id="send">Send</button>
</div>

<div id="users">
    <h3>Connected Users</h3>
    <ul id="userList"></ul>
</div>

<script>
const username = prompt("Enter username:");
let socket;

fetch(`http://localhost:8080/auth?username=${username}`)
.then(res => res.json())
.then(data => {
    socket = new WebSocket("ws://localhost:8080/ws");

    socket.onopen = () => {
        socket.send(JSON.stringify({ token: data.token }));
    };

    socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const messages = document.getElementById("messages");

        const div = document.createElement("div");

        if (msg.type === "system") {
            div.innerHTML = "<i>" + msg.content + "</i>";
        } else {
            div.innerHTML = "<b>" + msg.sender + ":</b> " + msg.content;
        }

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;

        loadUsers();
    };
});

document.getElementById("send").onclick = sendMessage;

function sendMessage() {
    const input = document.getElementById("input");
    const content = input.value;

    if (content && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ content }));
        input.value = "";
    }
}

function loadUsers() {
    fetch("http://localhost:8080/users")
    .then(res => res.json())
    .then(users => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        users.forEach(u => {
            const li = document.createElement("li");
            li.textContent = u;
            list.appendChild(li);
        });
    });
}
</script>

</body>
</html>
